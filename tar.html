<!DOCTYPE html>
<html>
<head>
<script>

function readstring(buf, offset, size) {
    let strView = new Uint8Array(buf, offset, size);
    let i = 0;
    let rtnStr = "";
    while(strView[i] != 0) {
        rtnStr += String.fromCharCode(strView[i]);
        i++;
    }
    return rtnStr;
}

function writestring(str, buf, offset, size) {
    let strView = new Uint8Array(buf, offset, size);
    for(let i = 0; i < size; i++) {
        if(i < str.length) {
            strView[i] = str.charCodeAt(i);
        } else {
            strView[i] = 0;
        }
    }
}

function readtype(buf, offset) {
    let typeView = new Uint8Array(buf, offset, 1);
    return String.fromCharCode(typeView[0]);
}

function writetype(buf, offset, typeStr) {
    let typeView = new Uint8Array(buf, offset, 1);
    typeView[0] = typeStr.charCodeAt(0); 
}

function leftPad(number, targetLength) {
    var output = number + '';
    while (output.length < targetLength) {
        output = '0' + output;
    }
    return output;
}

function fillHeader(buf, offset, typeStr) {
    writestring("0000664", buf, offset + 100, 8); // mode
    writestring("0001750", buf, offset + 108, 8); // uid
    writestring("0001750", buf, offset + 116, 8); // gid
    writestring("        ", buf, offset + 148, 8); // checksum
    writestring("13153345327", buf, offset + 136, 12); // mtime
    writestring("ustar", buf, offset + 257, 6);
    writestring("00", buf, offset + 263, 2);
    writestring("arohatgi", buf, offset + 265, 32);
    writestring("arohatgi", buf, offset + 297, 32);
    // calculate checksum
    let header = new Uint8Array(buf, offset, 512);
    let chksum = 0;
    for(let i = 0; i < 512; i++) {
        chksum += header[i];
    }
    writestring(chksum.toString(8), buf, offset + 148, 8);
}

function readsize(buf, offset) {
    let szView = new Uint8Array(buf, offset, 12);
    let szStr = "";
    for(let i = 0; i < 11; i++) {
        szStr += String.fromCharCode(szView[i]);
    }
    return parseInt(szStr,8);
}

function writesize(size, buf, offset) {
    let sz = size.toString(8);
    sz = leftPad(sz, 11);
    writestring(sz, buf, offset, 12);
}

function readtextfile(buf, offset, size) {
    let view = new Uint8Array(buf, offset, size);
    let data = "";
    for(let i = 0; i < size; i++) {
        data += String.fromCharCode(view[i]);
    }
    return data;
}

function readfileblob(buf, offset, size, mimetype) {
    let view = new Uint8Array(buf, offset, size);
    let blob = new Blob([view], {"type": mimetype});
    return blob;
}

function load() {
    let $elem = document.getElementById("fileLoader");
    let files = $elem.files;
    console.log("Number of files: ", files.length);
    let file = files[0];
    console.log("File size: ", file.size);
    console.log("File type: ", file.type);

    // read tar file
    let reader = new FileReader();
    reader.onload = function(event) {
        const buf = event.target.result;
                        
        // read binary buffer

        let offset = 0;
        let flsize = 0;       
        let flname = "";
        while(offset < buf.byteLength - 512) {
            flname = readstring(buf, offset, 100); // file name
            if(flname.length == 0) {
                break;
            }
            console.log("file name: ", flname);
            console.log(readtype(buf, offset + 156)); // 0 = file, 5 = dir
            flsize = readsize(buf, offset + 124);
            console.log("file size: ", flsize);
            if(flname.indexOf(".json") >= 0 || flname.indexOf(".txt") >= 0) {
                console.log(readtextfile(buf, offset + 512, flsize));
            } else if(flname.indexOf(".png") >= 0) {
                let blob = readfileblob(buf, offset + 512, flsize, "image/png");
                let imageUrl = window.URL.createObjectURL(blob);
                let $img = document.getElementById('outimg');
                $img.src = imageUrl;
            }
            offset += (512 + 512*Math.trunc(flsize/512));
            if(flsize%512) {
                offset += 512;
            }
        }
    };
    reader.readAsArrayBuffer(file);
}

function downloadBlob(blob) {
    let $downloadElem = document.createElement('a');
    $downloadElem.href = URL.createObjectURL(blob);
    $downloadElem.download = "generated.tar";
    $downloadElem.style.display = "none";
    document.body.appendChild($downloadElem);
    $downloadElem.click();
    document.body.removeChild($downloadElem);
}

function generate() {
    let $elem = document.getElementById("genFileLoader");
    let files = $elem.files;
    
    // calculate total tarball size
    let tarDataSize = 0;
    for(let fileIdx = 0; fileIdx < files.length; fileIdx++) {
        let flsize = files[fileIdx].size;
        // let flsize = 0;
        tarDataSize += 512 + 512*Math.trunc(flsize/512);
        if(flsize % 512) {
            tarDataSize += 512;
        }
    }
    let bufSize = 10240*Math.trunc(tarDataSize/10240);
    if(tarDataSize%10240) {
        bufSize += 10240;
    }
    let buf = new ArrayBuffer(bufSize);
    let offset = 0;
    let filesAdded = 0;
    let onFileAdded = function() {
        filesAdded++;
        if(filesAdded == files.length) {
            console.log("downloading..");
             let arr = new Uint8Array(buf);
             let blob = new Blob([arr], {"type":"application/x-tar"});
             downloadBlob(blob);
        }
    };

    for(let fileIdx = 0; fileIdx < files.length; fileIdx++) {
        let flsize = files[fileIdx].size;
        // let flsize = 0;
        let flname = files[fileIdx].name;
        writestring(flname, buf, offset, 100);
        writetype(buf, offset + 156, '0');
        writesize(flsize, buf, offset + 124);
        fillHeader(buf, offset);
        // write file data
        let reader = new FileReader();
        reader.onload = (function(destArray) {
                let destArr = destArray;
                return function(event) {
                    let readbuf = event.target.result;
                    let sourceArr = new Uint8Array(readbuf);
                    for(let byteIdx = 0; byteIdx < sourceArr.length; byteIdx++) {
                        destArr[byteIdx] = sourceArr[byteIdx];
                    }
                    onFileAdded();
                };
            })(new Uint8Array(buf, offset + 512, flsize)); 
        reader.readAsArrayBuffer(files[fileIdx]);

        offset += (512 + 512*Math.trunc(flsize/512));
        if(flsize%512) {
            offset += 512;
        }
    }
}

</script>
</head>
<body>
<h2>Read .tar</h2>
<p>Load File: <input type="file" id="fileLoader"/><input type="button" value="load" onclick="load();"/></p>
<p><img id="outimg"/></p>
<hr/>
<h2>Generate .tar</h2>
<p>Load File(s): <input type="file" id="genFileLoader" multiple/><input type="button" value="load" onclick="generate();"/></p>
</body>
</html>
